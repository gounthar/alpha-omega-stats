name: Test PR Collector

on:
  schedule:
    - cron: '18 07 * * 2'  # Run every Tuesday at 07:18 UTC
  workflow_dispatch:  # Allow manual trigger

jobs:
  test-pr-collector:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download latest plugins data
        run: |
          echo "Downloading latest Jenkins plugins data..."
          curl -L https://updates.jenkins.io/current/update-center.actual.json -o plugins.json
          echo "Download completed. File size: $(stat -c%s plugins.json) bytes"

      - name: Build Docker image
        run: docker build -t jenkins-pr-collector .

      - name: Run PR collector
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          docker run \
            -e GITHUB_TOKEN=$GITHUB_TOKEN \
            -v ${{ github.workspace }}/plugins.json:/app/plugins.json:ro \
            -v ${{ github.workspace }}/report.json:/app/report.json \
            -v ${{ github.workspace }}/found_prs.json:/app/found_prs.json \
            -v ${{ github.workspace }}/jenkins_prs.json:/app/jenkins_prs.json \
            jenkins-pr-collector

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: 'Update PR statistics report'
          title: 'Update PR statistics report'
          body: |
            This PR updates the PR statistics report using the jenkins-pr-collector.
            
            - Generated automatically by the PR Collector Test workflow
            - Data collection period: From August 2024 to current date
            - Using latest Jenkins plugins data from update-center.actual.json
          branch: update-pr-stats
          delete-branch: true
          base: main
